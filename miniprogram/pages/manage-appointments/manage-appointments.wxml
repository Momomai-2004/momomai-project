<view class="page-container">
  <!-- æœªç™»å½•æç¤º -->
  <view class="login-required" wx:if="{{!isLoggedIn}}">
    <view class="empty-icon"></view>
    <view class="empty-text">æ‚¨éœ€è¦ç™»å½•æ‰èƒ½ç®¡ç†é¢„çº¦</view>
    <view class="empty-subtext">å‘˜å·¥è´¦å·å¯ä»¥åœ¨æ­¤æŸ¥çœ‹å’Œç®¡ç†å®¢æˆ·é¢„çº¦</view>
    <button class="login-btn" bindtap="goToStaffLogin">ç™»å½•å‘˜å·¥è´¦å·</button>
  </view>

  <!-- ç™»å½•åå†…å®¹ -->
  <block wx:else>
    <!-- é¡¶éƒ¨ç»Ÿè®¡æ  -->
    <view class="stats-bar">
      <view class="stat-item">
        <view class="stat-value">{{stats.today || 0}}</view>
        <view class="stat-label">ä»Šæ—¥é¢„çº¦</view>
      </view>
      <view class="stat-item">
        <view class="stat-value">{{stats.pending || 0}}</view>
        <view class="stat-label">å¾…ç¡®è®¤</view>
      </view>
      <view class="stat-item">
        <view class="stat-value">{{stats.upcoming || 0}}</view>
        <view class="stat-label">æœªæ¥é¢„çº¦</view>
      </view>
    </view>

    <!-- å¿«æ·æ“ä½œæ  -->
    <view class="quick-actions">
      <button class="action-btn confirm-btn" bindtap="confirmAllPending" wx:if="{{stats.pending > 0}}">
        <text class="action-icon">âœ“</text>
        <text>ç¡®è®¤å¾…å¤„ç† ({{stats.pending}})</text>
      </button>
    </view>

    <!-- è¿æ¥çŠ¶æ€æ˜¾ç¤º -->
    <view class="connection-status {{connectionStatus === 'error' ? 'error' : 'normal'}}">
      <text wx:if="{{connectionStatus === 'error'}}">äº‘ç¯å¢ƒè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ</text>
      <text wx:else>æœ€åæ›´æ–°: {{lastRefreshTime || 'æœªåˆ·æ–°'}}</text>
    </view>

    <!-- ä¸‹æ‹‰åˆ·æ–°æç¤º -->
    <view class="pull-refresh-tip">
      <text>ğŸ‘‡ ä¸‹æ‹‰åˆ·æ–°é¢„çº¦æ•°æ®</text>
    </view>

    <!-- å¤´éƒ¨æœç´¢å’Œç­›é€‰ -->
    <view class="header">
      <view class="search-bar">
        <icon type="search" size="14"></icon>
        <input 
          placeholder="æœç´¢å®¢æˆ·å§“åæˆ–ç”µè¯" 
          bindinput="onSearchInput"
          value="{{searchQuery}}"
        />
        <icon wx:if="{{searchQuery}}" type="clear" size="14" bindtap="clearSearch"></icon>
      </view>

      <view class="tabs">
        <view 
          class="tab {{activeTab === 'today' ? 'active' : ''}}" 
          data-tab="today" 
          bindtap="switchTab"
        >ä»Šæ—¥</view>
        <view 
          class="tab {{activeTab === 'upcoming' ? 'active' : ''}}" 
          data-tab="upcoming" 
          bindtap="switchTab"
        >å³å°†åˆ°æ¥</view>
        <view 
          class="tab {{activeTab === 'all' ? 'active' : ''}}" 
          data-tab="all" 
          bindtap="switchTab"
        >å…¨éƒ¨</view>
      </view>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-state" wx:if="{{isLoading}}">
      <view class="loading-spinner"></view>
      <text>æ­£åœ¨åŠ è½½é¢„çº¦æ•°æ®...</text>
    </view>

    <!-- ç©ºçŠ¶æ€æ˜¾ç¤º -->
    <view class="empty-state" wx:elif="{{filteredAppointments.length === 0}}">
      <view class="empty-icon {{activeTab}}"></view>
      <text wx:if="{{searchQuery}}">æœªæ‰¾åˆ°åŒ¹é…"{{searchQuery}}"çš„é¢„çº¦</text>
      <text wx:elif="{{activeTab === 'today'}}">ä»Šå¤©æ²¡æœ‰é¢„çº¦å®‰æ’</text>
      <text wx:elif="{{activeTab === 'upcoming'}}">è¿‘æœŸæ²¡æœ‰æ–°çš„é¢„çº¦</text>
      <text wx:else>æš‚æ— é¢„çº¦è®°å½•</text>
      <view class="empty-action">
        <button class="refresh-btn" bindtap="refreshAppointments">
          <text class="refresh-icon">ğŸ”„</text>
          <text>åˆ·æ–°æ•°æ®</text>
        </button>
      </view>
    </view>

    <!-- é¢„çº¦åˆ—è¡¨ -->
    <view class="appointment-list" wx:else>
      <view 
        class="appointment-card"
        wx:for="{{filteredAppointments}}"
        wx:key="index"
        data-status="{{item.status}}"
      >
        <view class="appointment-header">
          <view class="appointment-service">{{item.serviceName}}</view>
          <view class="appointment-status-tag {{item.status}}">{{statusTexts[item.status]}}</view>
        </view>

        <view class="appointment-time">
          <text class="date">{{item.formattedDate}}</text>
          <text class="time">{{item.startTime}} - {{item.endTime}}</text>
        </view>

        <view class="appointment-customer">
          <text class="customer-name">{{item.customerName}}</text>
          <text class="customer-phone">{{item.customerPhone}}</text>
        </view>

        <!-- æ·»åŠ æ²»ç–—å¸ˆä¿¡æ¯ -->
        <view class="therapist-info" wx:if="{{item.therapistName}}">
          <image class="therapist-avatar" src="{{item.therapistAvatar || '/images/default-avatar.png'}}"></image>
          <view class="therapist-details">
            <text class="therapist-name">{{item.therapistName}}</text>
            <text class="therapist-title" wx:if="{{item.therapistTitle}}">{{item.therapistTitle}}</text>
          </view>
        </view>

        <!-- é¢„çº¦å¤‡æ³¨ -->
        <view class="appointment-notes" wx:if="{{item.notes}}">
          <view class="notes-icon">ğŸ“</view>
          <view class="notes-content">{{item.notes}}</view>
        </view>

        <!-- æ“ä½œæŒ‰é’® -->
        <view class="appointment-actions">
          <block wx:if="{{item.status === 'pending'}}">
            <button class="action-btn confirm-btn" data-id="{{item._id}}" bindtap="confirmAppointment">ç¡®è®¤</button>
            <button class="action-btn reschedule-btn" data-id="{{item._id}}" bindtap="rescheduleAppointment">æ”¹æœŸ</button>
            <button class="action-btn cancel-btn" data-id="{{item._id}}" bindtap="cancelAppointment">å–æ¶ˆ</button>
          </block>
          <block wx:elif="{{item.status === 'confirmed'}}">
            <button class="action-btn complete-btn" data-id="{{item._id}}" bindtap="completeService">å®Œæˆ</button>
            <button class="action-btn reschedule-btn" data-id="{{item._id}}" bindtap="rescheduleAppointment">æ”¹æœŸ</button>
            <button class="action-btn cancel-btn" data-id="{{item._id}}" bindtap="cancelAppointment">å–æ¶ˆ</button>
          </block>
          <block wx:elif="{{item.status === 'completed'}}">
            <button class="action-btn details-btn" data-index="{{index}}" bindtap="viewCompletedAppointmentDetails">æŸ¥çœ‹è¯¦æƒ…</button>
          </block>
          <block wx:elif="{{item.status === 'cancelled'}}">
            <button class="action-btn details-btn" data-index="{{index}}" bindtap="viewCancelledAppointmentDetails">æŸ¥çœ‹è¯¦æƒ…</button>
          </block>
        </view>
      </view>

      <!-- åº•éƒ¨æç¤º -->
      <view class="bottom-tips" wx:if="{{filteredAppointments.length > 0}}">
        <text>å·²æ˜¾ç¤ºå…¨éƒ¨ {{filteredAppointments.length}} æ¡é¢„çº¦</text>
      </view>
    </view>
  </block>
</view> 